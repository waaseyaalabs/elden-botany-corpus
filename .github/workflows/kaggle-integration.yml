name: Kaggle Integration

on:
  workflow_dispatch:
    inputs:
      force_download:
        description: 'Force re-download of datasets'
        required: false
        default: 'false'
        type: choice
        options:
          - 'true'
          - 'false'
  push:
    branches:
      - main
  pull_request:
    branches:
      - main
  schedule:
    # Run weekly on Sundays at 00:00 UTC to refresh datasets
    - cron: '0 0 * * 0'

permissions:
  contents: read

jobs:
  kaggle-smoke-test:
    runs-on: ubuntu-latest
    env:
      KAGGLE_USERNAME: ${{ secrets.KAGGLE_USERNAME }}
      KAGGLE_KEY: ${{ secrets.KAGGLE_KEY }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Verify Kaggle secrets are available
        run: |
          if [ -z "${KAGGLE_USERNAME}" ] || [ -z "${KAGGLE_KEY}" ]; then
            echo "KAGGLE_USERNAME and KAGGLE_KEY must be defined as repository secrets."
            exit 1
          fi

      - name: Configure Kaggle credentials
        run: |
          mkdir -p ~/.kaggle
          cat <<EOF > ~/.kaggle/kaggle.json
          {
            "username": "${KAGGLE_USERNAME}",
            "key": "${KAGGLE_KEY}"
          }
          EOF
          chmod 600 ~/.kaggle/kaggle.json

      - name: Install Kaggle client
        run: |
          python -m pip install --upgrade pip
          pip install kaggle

      - name: Kaggle API smoke test
        run: |
          kaggle datasets list -s "titanic" | head -n 5

  kaggle-dataset-ingestion:
    runs-on: ubuntu-latest
    needs: kaggle-smoke-test
    # Only run on workflow_dispatch or scheduled events
    if: github.event_name == 'workflow_dispatch' || github.event_name == 'schedule'
    env:
      KAGGLE_USERNAME: ${{ secrets.KAGGLE_USERNAME }}
      KAGGLE_KEY: ${{ secrets.KAGGLE_KEY }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Configure Kaggle credentials
        run: |
          mkdir -p ~/.kaggle
          cat <<EOF > ~/.kaggle/kaggle.json
          {
            "username": "${KAGGLE_USERNAME}",
            "key": "${KAGGLE_KEY}"
          }
          EOF
          chmod 600 ~/.kaggle/kaggle.json

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install kaggle pyyaml

      - name: Download Kaggle datasets
        run: |
          FORCE_FLAG=""
          if [ "${{ github.event.inputs.force_download }}" = "true" ]; then
            FORCE_FLAG="--force"
          fi
          
          python -m scripts.download_kaggle_dataset \
            --config config/kaggle_datasets.yml \
            --output-dir data/raw \
            $FORCE_FLAG \
            --verbose

      - name: Verify data directory structure
        run: |
          echo "=== Data directory structure ==="
          ls -lhR data/raw/ || echo "No data downloaded"
          
          echo ""
          echo "=== Disk usage ==="
          du -sh data/raw/* 2>/dev/null || echo "No directories to measure"

      - name: Upload data summary as artifact
        if: always()
        run: |
          mkdir -p artifacts
          echo "# Kaggle Data Ingestion Summary" > artifacts/ingestion-summary.md
          echo "" >> artifacts/ingestion-summary.md
          echo "**Date:** $(date -u +%Y-%m-%dT%H:%M:%SZ)" >> artifacts/ingestion-summary.md
          echo "**Trigger:** ${{ github.event_name }}" >> artifacts/ingestion-summary.md
          echo "**Force Download:** ${{ github.event.inputs.force_download || 'false' }}" >> artifacts/ingestion-summary.md
          echo "" >> artifacts/ingestion-summary.md
          echo "## Directory Structure" >> artifacts/ingestion-summary.md
          echo "\`\`\`" >> artifacts/ingestion-summary.md
          ls -lhR data/raw/ >> artifacts/ingestion-summary.md 2>&1 || echo "No data" >> artifacts/ingestion-summary.md
          echo "\`\`\`" >> artifacts/ingestion-summary.md

      - name: Upload ingestion summary
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: kaggle-ingestion-summary
          path: artifacts/ingestion-summary.md
          retention-days: 30
